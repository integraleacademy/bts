{% extends 'base.html' %}
{% block content %}
<h2>Administration</h2>

<div class="card">
  <form method="post" action="/admin/add" class="add-form">
    <input name="nom" placeholder="Nom" required>
    <input name="prenom" placeholder="Pr√©nom" required>
    <button class="admin-btn">‚ûï Ajouter</button>
  </form>
</div>

<div class="card">
  <table class="admin-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Pr√©nom</th>
        <th>Email</th>
        <th>T√©l√©phone</th>
        <th>Status</th>
        <th>Commentaire</th>
        <th>Logs</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.nom }}</td>
        <td>{{ r.prenom }}</td>
        <td>{{ r.mail or '-' }}</td>
        <td>{{ r.tel or '-' }}</td>
        <td>
          <span class="badge" style="background: {{ r.status|status_color }};">
            {{ r.status }}
          </span>
          <form method="post" action="/update/{{r.id}}" class="inline-form">
            <select name="status">
              {% for s in statuses %}
                <option value="{{s}}" {% if s == r.status %}selected{% endif %}>{{s}}</option>
              {% endfor %}
            </select>
            <button type="submit" class="admin-btn small">üíæ</button>
          </form>
        </td>
        <td>
          <form method="post" action="/update_comment/{{r.id}}" class="inline-form">
            <input type="text" name="commentaire" value="{{ r.commentaire or '' }}" placeholder="Ajouter un commentaire">
            <button type="submit" class="admin-btn small">üíæ</button>
          </form>
        </td>
        <td>
          {% if r.logs %}
            <button class="admin-btn small" onclick="openLogs('{{ r.id }}')">üìú Voir logs</button>

            <!-- Fen√™tre modale -->
            <div id="modal-{{ r.id }}" class="modal">
              <div class="modal-content">
                <span class="close" onclick="closeLogs('{{ r.id }}')">&times;</span>
                <h3>Historique des mails</h3>
                <ul>
                  {% for log in r.logs %}
                    <li>{{ log }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <a class="admin-btn small" href="{{ url_for('edit', id=r.id) }}">‚úèÔ∏è Modifier</a>
          <form method="post" action="/delete/{{r.id}}" class="inline-form">
            <button type="submit" class="admin-btn small danger">üóëÔ∏è Supprimer</button>
          </form>
          <a class="admin-btn small" href="{{ url_for('fiche', id=r.id) }}">üñ®Ô∏è Fiche</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Styles modale -->
<style>
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content {
  background:#fff; margin:10% auto; padding:20px; border-radius:8px;
  width:80%; max-width:500px; box-shadow:0 2px 10px rgba(0,0,0,0.3);
}
.modal-content h3 { margin-top:0; }
.close { float:right; font-size:22px; cursor:pointer; }
</style>

<!-- Script ouverture/fermeture -->
<script>
function openLogs(id) {
  document.getElementById("modal-" + id).style.display = "block";
}
function closeLogs(id) {
  document.getElementById("modal-" + id).style.display = "none";
}
window.onclick = function(event) {
  document.querySelectorAll(".modal").forEach(function(modal){
    if (event.target === modal) modal.style.display = "none";
  });
}
</script>

<style>
a.admin-btn {
  text-decoration: none !important;
}
</style>

{% endblock %}
